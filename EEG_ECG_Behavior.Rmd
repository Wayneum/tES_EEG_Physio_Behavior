---
title: 'The Spacekime Analytics of EEG, ECG, and Behavior with Multiple Doses of tDCS'
author: "<h3>SOCR/MIDAS (Yuan-Yu Lin)</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
---

```{r}
library(ggfortify)

library(manipulateWidget)
library(transport)
library(shapes)
library(TCIU)
library(DT)
library(ggplot2)

library(R.matlab)
library(plotly)
library(dplyr)
library(tidyr)

```

## import the data

### The dataset is from the <https://figshare.com/articles/figure/Dataset_of_Concurrent_EEG_ECG_and_Behavior_with_Multiple_Doses_of_transcranial_Electrical_Stimulation-_Stimulation_Trials_PSD/14810517>

```{r}
# import  Experiment_1 0101

##  setwd('/Users/waynelin/Desktop/umich/SOCR/R_code/EEG_ECG_Behavior/Exp1_Raw Data/0101')


path_Exp1 <- "/Users/waynelin/Desktop/umich/SOCR/R_code/EEG_ECG_Behavior/Exp1_Raw Data"
path_0101<- file.path(path_Exp1, "0101")


EEG_0101_raw_data <- readMat(file.path(path_0101, "EEG_DS_Struct_0101.mat"))
behavioral_CTT_0101_raw_data <- read.csv(file.path(path_0101, "0101", "ptracker-0101.csv"))

head(EEG_0101_raw_data)
str(EEG_0101_raw_data)

head(behavioral_CTT_0101_raw_data)
str(behavioral_CTT_0101_raw_data)

```

### understand the data structure -

#### 

#### DSamp

triggers \<- These are all the labeled EEG/Stimulation start/stop triggers

EEGdata \<- Contains the downsampled EEG/ECG/EOG voltage data dims: 35 channelss X \~4E6 samples

fs \<- The downsampled sampling frequency of the data : 1000 Hz. #####1000 samples per second.

fsOld \<- The original sampling frequency of the data

time \<- Time vector for the data. Should be 1 X \~4E6

label \<- Contains the channel label information. BIP1= ECG, BIP2=EOG, RESP1= N/A

nchan \<- The number of channels in the data

rate \<- Redundant to fs, sampling rate of data

npt \<- Number of data points \~4E6

Subj \<- Subject and session that data belong to. I.e. 0302 - Subject 03 session 03

ptrackerPerf \<- The CTT data deviation/ the behavioral data

ptrackerTime \<- Time vector for the CTT data

ptrackerfs \<- The sampling frequency for the CTT data 100 Hz.
(source: https://github.com/ngebodh/GX_tES_EEG_Physio_Behavior)

```{r}
## Prepare the data for analyze

EEG_data_0101 <- EEG_0101_raw_data[["DSamp"]][[2]]
EEG_time_0101 <- EEG_0101_raw_data[["DSamp"]][[5]]
channel_label <- EEG_0101_raw_data[["DSamp"]][[6]]


# Create a data frame for plotting(test)

test_channel_range <- 1:3
test_sample_range <- 1:600000   #. 10 min


eeg_subset <- EEG_data_0101[test_channel_range, test_sample_range]
time_subset <- EEG_time_0101[test_sample_range]
test_channel_label <- channel_label[test_channel_range]
channel_labels <- sapply(test_channel_label, function(x) x[[1]])

plot_test_df <- data.frame(Time = rep(time_subset, times = length(test_channel_range)),
                 Channel = factor(rep(paste0("Ch", test_channel_range), each = length(test_sample_range))),
                 Voltage = as.vector(t(eeg_subset)))
plot_test_df$Channel <- factor(plot_test_df$Channel,
                                      levels = c("Ch1", "Ch2", "Ch3"),
                                      labels = channel_labels)

```

### Calculate mean values for each channel
```{r}
plot_test_df_binned <- plot_test_df %>%
  mutate(Time_bin = round(Time, 2)) %>%  # rounds time to 0.01s
  group_by(Time_bin, Channel) %>%
  summarize(mean_voltage = mean(Voltage, na.rm = TRUE), .groups = "drop")






```

# Create interactive plot
```{r}
EEG_0101_interactive_plot_test <- plot_ly() %>%
  add_trace(data = plot_test_df, x = plot_test_df$Time, y = plot_test_df$Voltage, color = plot_test_df$Channel, type = 'scatter', mode = 'lines') %>% 
  layout(title = "Interactive plot between first 3 channels over ten minutes", xaxis = list(title = "Time (sec)"), yaxis = list(title = "Voltage"))
EEG_0101_interactive_plot_test

#EEG_0101_interactive_plot_test %>% add_trace(data= plot_test_df_binned, x = ~Time_bin, y = ~mean_voltage, type = 'scatter', mode = 'lines' )
## ???
```


```{r}

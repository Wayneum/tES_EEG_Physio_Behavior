---
title: 'The Spacekime Analytics of EEG, ECG, and Behavior with Multiple Doses of tDCS'
author: "<h3>SOCR/MIDAS (Yuan-Yu Lin)</h3>"
date: "`r format(Sys.time(), '%B %Y')`"
---

```{r}
library(ggfortify)

library(manipulateWidget)
library(transport)
library(shapes)
library(TCIU)
library(DT)
library(ggplot2)

library(R.matlab)
library(plotly)
library(dplyr)
library(tidyr)

```

## import the data

### The dataset is from the <https://figshare.com/articles/figure/Dataset_of_Concurrent_EEG_ECG_and_Behavior_with_Multiple_Doses_of_transcranial_Electrical_Stimulation-_Stimulation_Trials_PSD/14810517>

```{r}
# import  Experiment_1 0101

##  setwd('/Users/waynelin/Desktop/umich/SOCR/R_code/EEG_ECG_Behavior/Exp1_Raw Data/0101')


path_Exp1 <- "/Users/waynelin/Desktop/umich/SOCR/R_code/EEG_ECG_Behavior/Exp1_Raw Data"
path_0101<- file.path(path_Exp1, "0101")


EEG_0101_raw_data <- readMat(file.path(path_0101, "EEG_DS_Struct_0101.mat"))
behavioral_CTT_0101_raw_data <- read.csv(file.path(path_0101, "0101", "ptracker-0101.csv"))

head(EEG_0101_raw_data)
str(EEG_0101_raw_data)

head(behavioral_CTT_0101_raw_data)
str(behavioral_CTT_0101_raw_data)

```

### understand the data structure -

#### 

#### DSamp

triggers \<- These are all the labeled EEG/Stimulation start/stop triggers

EEGdata \<- Contains the downsampled EEG/ECG/EOG voltage data dims: 35 channelss X \~4E6 samples

fs \<- The downsampled sampling frequency of the data : 1000 Hz. #####1000 samples per second.

fsOld \<- The original sampling frequency of the data

time \<- Time vector for the data. Should be 1 X \~4E6

label \<- Contains the channel label information. BIP1= ECG, BIP2=EOG, RESP1= N/A

nchan \<- The number of channels in the data

rate \<- Redundant to fs, sampling rate of data

npt \<- Number of data points \~4E6

Subj \<- Subject and session that data belong to. I.e. 0302 - Subject 03 session 03

ptrackerPerf \<- The CTT data deviation/ the behavioral data

ptrackerTime \<- Time vector for the CTT data

ptrackerfs \<- The sampling frequency for the CTT data 100 Hz.
(source: https://github.com/ngebodh/GX_tES_EEG_Physio_Behavior)

```{r}
## Prepare the data for analyze

EEG_data_0101 <- EEG_0101_raw_data[["DSamp"]][[2]]
EEG_time_0101 <- EEG_0101_raw_data[["DSamp"]][[5]]
channel_label <- EEG_0101_raw_data[["DSamp"]][[6]]


# Create a data frame for plotting(test)

test_channel_range <- 1:3
test_sample_range <- 1:600000 #. 10 minutes



eeg_subset <- EEG_data_0101[test_channel_range, test_sample_range]
time_subset <- EEG_time_0101[test_sample_range]
test_channel_label <- channel_label[test_channel_range]
channel_labels <- sapply(test_channel_label, function(x) x[[1]])

plot_test_df <- data.frame(Time = rep(time_subset, times = length(test_channel_range)),
                 Channel = factor(rep(paste0("Ch", test_channel_range), each = length(test_sample_range))),
                 Voltage = as.vector(t(eeg_subset)))
plot_test_df$Channel <- factor(plot_test_df$Channel,
                                      levels = c("Ch1", "Ch2", "Ch3"),
                                      labels = channel_labels)





```

```{r}
## create dataframe and export as CSV file

create_sub_df_fun<- function(EEG_dataset, EEG_time_dataset , channel_range_variable, time_range_variable){
  eeg_subset <- EEG_dataset[channel_range_variable, time_range_variable]
  time_subset <- EEG_time_dataset[time_range_variable]
  test_channel_label <- channel_label[channel_range_variable]
  channel_labels <- sapply(test_channel_label, function(x) x[[1]])
  
  internal_fun_df <- data.frame(Time = rep(time_subset, times = length(channel_range_variable)),
                   Channel = factor(rep(paste0("Ch", channel_range_variable), each = length(time_range_variable)), 
                   levels = paste0("Ch", channel_range_variable), labels = channel_labels),
  Voltage = as.vector(t(eeg_subset)))

  return (internal_fun_df)
}

#combine the function of create_sub_df_function and output_csv_ fun 
create_sub_df_and_export_csv <- function(EEG_dataset, EEG_time_dataset , channel_range_variable, time_range_variable, CSV_name){
  internal_create_df <- create_sub_df_fun(EEG_dataset, EEG_time_dataset , channel_range_variable, time_range_variable)
  output_csv_fun(internal_create_df, CSV_name)
}


# export all dataframe and save in one csv file 
create_sub_df_and_export_csv(EEG_data_0101, EEG_time_0101,1:35, 1:4227788, "EEG_all_channel_all_time.csv")

# export each channel data frame and save  csv file
export_specific_channel <- function(channel_number){
  test_channel_label <- channel_label[channel_number]
  channel_labels <- sapply(test_channel_label, function(x) x[[1]])
  export_name_for_csv <- paste0("EEG_",channel_labels,"_all_time.csv")
  export_x <- create_sub_df_fun(EEG_data_0101,EEG_time_0101, channel_number, 1:4227788)
  output_csv_fun(export_x,export_name_for_csv)
}

for (ch in 1:35) {
  export_specific_channel(ch)
}



```

### Calculate mean values for each channel
```{r}
plot_test_df_binned <- plot_test_df %>%
  mutate(Time_bin = round(Time, 2)) %>%  # rounds time to 0.01s
  group_by(Time_bin, Channel) %>%
  summarize(mean_voltage = mean(Voltage, na.rm = TRUE), .groups = "drop")


```

### Create interactive plot
```{r}
EEG_0101_interactive_plot_test <- plot_ly() %>%
  add_trace(data = plot_test_df, x = plot_test_df$Time, y = plot_test_df$Voltage, color = plot_test_df$Channel, type = 'scatter', mode = 'lines') %>% 
  layout(title = "Interactive plot between first 3 channels over ten minutes", xaxis = list(title = "Time (sec)"), yaxis = list(title = "Voltage"))
EEG_0101_interactive_plot_test


```


# tansfore the plot_test_df to CSV formate
```{r}
# output Long Format to csv file
filter_data_frame <- function(input_dataFrame, filter_variable) {
  # Filter the data frame where Channel matches filter_variable
  filtered_df <- input_dataFrame[input_dataFrame$Channel == filter_variable, ]
  return(filtered_df)
}
combine_fun <- function (origin_df, target_df){
  temp_df = data.frame()
  
}

test_Fp1_df <- filter_data_frame(plot_test_df,"Fp1")
test_Fpz_df <- filter_data_frame(plot_test_df, "Fpz")
test_Fp2_df <- filter_data_frame(plot_test_df, "Fp2")

channel_name_label_fun <- function(channel_name){
  out_put = paste0("Voltage_", channel_name)
  return (out_put)
  }

combine_test_df_fun <- function(to_df, target1_df, target2_df){ 
  to_df_name <- unique(to_df$Channel)
  target1_df_name <- unique(target1_df$Channel)
  target2_df_name <- unique(target2_df$Channel)
  to_df <- to_df[, c("Time", "Voltage")]
  df1 <- target1_df[, c("Time", "Voltage")]
  df2 <- target2_df[, c("Time", "Voltage")]
  names(to_df)[2] <- channel_name_label_fun(to_df_name)
  names(df1)[2] <-channel_name_label_fun(target1_df_name)
  names(df2)[2] <-channel_name_label_fun(target2_df_name)
  combined_df <- merge(to_df, df1,by = "Time")
  combined_df <- merge(combined_df, df2,by = "Time" )
  return (combined_df)
}

combined_three_df <- combine_test_df_fun(test_Fp1_df,test_Fp2_df,test_Fpz_df)
head(combined_three_df)

output_csv_fun <- function(input_df, csv_name){
  write.csv(input_df, file = csv_name, row.names = FALSE)
}


output_csv_fun(plot_test_df, "test_multiple_channel.csv")
output_csv_fun(test_Fp1_df, "test_Fp1_output.csv")
output_csv_fun(test_Fp1_df, "test_Fpz_output.csv")
output_csv_fun(test_Fp1_df, "test_Fp2_output.csv")
output_csv_fun(combined_three_df, "Fp1_Fpz_Fp2_output.csv")


```

### Generate the kime-phases
```{r}
head(test_Fp1_df)
head(test_Fp2_df)
head(test_Fpz_df)

phi_8_vec <- matrix(NA, ncol=10, nrow = 8)
for (t in 1:10) { 
  # for a given t, generate 8 new phases
  set.seed(t);
  phi_8_vec[ ,t] <-
    extraDistr::rlaplace(8, mu=0, sigma=0.5)
  # rank-order the phases for consistency
  # within the same foliation leaf
  phi_8_vec[ ,t] <- sort(phi_8_vec[ ,t])
  # force phases in [-pi: pi)
  for (i in 1:8) {
    if (phi_8_vec[i,t] < -pi) 
      phi_8_vec[i,t] <- -pi
    if (phi_8_vec[i,t] >= pi) 
      phi_8_vec[i,t] <- pi
  }
}



```

```{r}
